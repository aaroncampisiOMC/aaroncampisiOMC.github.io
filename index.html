<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vastify</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
  <link rel="icon" href="/check_circle_100dp_1F1F1F_FILL0_wght400_GRAD0_opsz48.png" type="image/png">
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background-color: #F9F9F9;
      color: #777;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
    }

    .page {
      padding: 50px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
      width: 100%;
      justify-content: center;
      gap: 0;
    }

    header {
      display: flex;
      align-items: center;
      top: 40px;
      width: 100%;
      max-width: 1500px;
      gap: 12px;
      margin-bottom: auto;
      padding-top: 20px;
      transition: all 0.4s ease;
    }

    footer {
      margin-top: auto;
    }

    h1 {
      font-family: 'DM Sans', Arial, sans-serif;
      font-size: 3rem;
      font-weight: 600;
      background: linear-gradient(90deg, #444, #444);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      letter-spacing: -0.5px;
    }

    h2 {
      font-family: 'Inter', Arial, sans-serif;
      font-size: 1.2rem;
      font-weight: 400;
      background: linear-gradient(90deg, #444, #444);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      letter-spacing: -0.5px;
      position: relative;
      top: 4px;
    }

    .container {
      flex: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 40px;
      width: 100%;
      max-width: 1500px;
      margin-top: 0;
      transition: all 0.4s ease;
    }

    .left,
    .right {
      position: sticky;
      top: 250px;
      align-self: flex-start;
    }

    .left {
      flex: 1;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      width: 100%;
    }

    .right {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    #controls {
      display: flex;
      gap: 12px;
      width: 100%;
      align-items: flex-start;
    }

    #tag {
      width: 100%;
      display: block;
      resize: none;
      overflow-y: scroll;
      height: auto;
      max-height: 80px;
      padding: 12px 16px;
      border-radius: 20px;
      border: 0 solid #bbb;
      font-family: 'Inter', Arial, sans-serif;
      font-size: 1rem;
      font-weight: 400;
      outline: none;
      box-sizing: border-box;
      background: #eeeeee;
      transition: height 0.2s ease, border 0.2s, box-shadow 0.2s;
      scrollbar-width: none;
      -ms-overflow-style: none;
      color: #444;
    }

    #tag::-webkit-scrollbar {
      display: none;
    }

    #tag:focus {
      border-color: #4286f4;
      box-shadow: 0 0 0 2px #4286f433;
    }

    .gradient-btn {
      position: relative;
      padding: 12px 24px;
      font-family: 'Inter', Arial, sans-serif;
      background: #F9F9F9;
      border-radius: 100px;
      border: none;
      display: flex;
      justify-content: center;
      align-items: center;
      text-decoration: none;
      overflow: hidden;
      cursor: pointer;
      flex-shrink: 0;
    }

    .gradient-btn::before {
      content: '';
      position: absolute;
      width: 300px;
      height: 300px;
      background: conic-gradient(#29f8ff, #277dff, #a700ff, #ff2fc1, #29f8ff);
      animation: spin 3s linear infinite;
    }

    .gradient-btn::after {
      content: '';
      position: absolute;
      inset: 2px;
      background: #eeeeee;
      border-radius: 100px;
      z-index: 1;
      transition: background 0.3s ease, color 0.3s ease, transform 0.1s ease;
    }

    .gradient-btn:hover::after {
      background: #dddddd;
    }

    .content {
      position: relative;
      z-index: 2;
      color: #777;
      font-size: 1rem;
      font-weight: 400;
      display: flex;
      align-items: center;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #info {
      margin-top: 20px;
      background: #eeeeee;
      border-radius: 20px;
      padding: 16px 20px;
      font-family: 'Inter', Arial, sans-serif;
      font-weight: 400;
      font-size: 0.875rem;
      line-height: 1.6;
    }

    #info h3 {
      font-family: 'Inter', Arial, sans-serif;
      margin: 0 0 8px;
      font-size: 1rem;
      font-weight: 400;
      color: #777;
    }

    #logs {
      font-family: 'Inter', Arial, sans-serif;
      font-weight: 400;
      white-space: pre-wrap;
      font-size: 0.75rem;
      height: 200px;
      overflow: auto;
      margin-top: 20px;
      padding: 16px 20px;
      border-radius: 20px;
      background: #eeeeee;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #clearLogs,
    #refresh,
    .macro-action {
      font-family: 'Inter', Arial, sans-serif;
      padding: 8px 18px;
      background: transparent;
      color: #999;
      border: 0 solid #ccc;
      border-radius: 100px;
      font-size: 0.875rem;
      font-weight: 400;
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease, transform 0.1s ease;
    }

    #clearLogs, 
    #refresh {
      margin: 5px 0 0;
      text-align: center;
    }

    .macro-action {
      margin-top: 5px;
      text-align: left;
      width: fit-content;
    }

    #clearLogs:hover,
    #refresh:hover,
    .macro-action:hover {
      color: #4286f433;
    }

    #player {
      position: relative;
      width: 768px;
      height: 432px;
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.4s ease;
      background: url('https://i.pinimg.com/originals/54/58/a1/5458a14ae4c8f07055b7441ff0f234cf.gif') center/contain no-repeat;
    }

    video {
      width: 100%;
      height: 100%;
      display: block;
      border-radius: inherit;
      background: transparent;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    video.loaded {
      opacity: 1;
    }

    #ad-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
    }

    @media (max-width: 1600px) {
      .container {
        flex-direction: column;
        gap: 20px;
        margin-top: 50px;
        align-items: center;
        transition: all 0.4s ease;
      }

      .left,
      .right {
        position: static;
        width: 100%;
      }

      .left {
        max-width: 600px;
        align-items: center;
        margin: 0 auto;
      }

      header {
        max-width: 600px;
      }

      #controls,
      #tag,
      #request,
      #info,
      #logs {
        width: 100%;
        max-width: 600px;
      }

      #controls {
        flex-direction: row;
      }

      #request {
        text-align: center;
      }

      .macro-action {
        align-self: flex-start;
      }

      #player {
        width: 100%;
        max-width: 768px;
        height: auto;
        aspect-ratio: 16 / 9;
        transition: all 0.4s ease;
      }

      #logs {
        height: 160px;
      }

      #info,
      #logs {
        margin-top: 20px;
        box-sizing: border-box;
      }

      .left > div:last-child {
        align-self: stretch;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    
    <header>
      <h1>Vastify</h1>
      <h2>VAST tag tester</h2>
    </header>

      <div class="container">
        <div class="left">
          <div id="controls">
            <div id="tag-wrapper" style="flex:1; display:block;">
              <textarea id="tag" placeholder="Paste VAST tag URL here" rows="1"></textarea>
            </div>
            <button class="gradient-btn">
              <div class="content">
                <span>Load tag</span>
              </div>
            </button>
          </div>
          <div id="macroReplace" class="macro-action">Fix third-party macros</div>

          <div id="info">
            <h3>Ad Info</h3>
            <div id="ad-details">No ad loaded yet.</div>
          </div>

          <div id="logs"></div>
            <div style="display: flex; gap: 8px; justify-content: left;">
              <button id="clearLogs">Clear log</button>
              <button id="refresh">Refresh</button>
            </div>
        </div>

        <div class="right">
          <div id="player">
            <video id="content"
            playsinline
            preload="auto"
            controls>
            </video>
            <div id="ad-container"></div>
          </div>
        </div>
      </div>

      <footer>
        <p style="font-family: 'Inter', Arial, sans-serif; font-size: 0.75rem; color: #888;">OMG Facilitator Digital Operations</p>
      </footer>
  
  </div>

  <script>
    const content = document.getElementById('content');
    const adContainer = document.getElementById('ad-container');
    const logs = document.getElementById('logs');
    const adDetails = document.getElementById('ad-details');
    const log = (...a) => {
      logs.textContent += a.join(' ') + '\n';
      logs.scrollTop = logs.scrollHeight;
    };

    // Custom VAST Parser
    class VASTParser {
      constructor() {
        this.maxRedirects = 5;
      }

      async parseVAST(url, redirectCount = 0) {
        if (redirectCount >= this.maxRedirects) {
          throw new Error('Max VAST redirects exceeded');
        }

        log(`Fetching VAST from: ${url}`);
        
        try {
          const response = await fetch(url);
          const text = await response.text();
          const parser = new DOMParser();
          const xml = parser.parseFromString(text, 'text/xml');

          // Check for XML parsing errors
          const parserError = xml.querySelector('parsererror');
          if (parserError) {
            throw new Error('XML parsing error');
          }

          const vast = xml.querySelector('VAST');
          if (!vast) {
            throw new Error('Invalid VAST response');
          }

          const version = vast.getAttribute('version');
          log(`VAST version: ${version}`);

          // Check for wrapper (redirect)
          const wrapper = xml.querySelector('Wrapper');
          if (wrapper) {
            log('VAST Wrapper detected, following redirect...');
            const vastAdTagURI = wrapper.querySelector('VASTAdTagURI');
            if (vastAdTagURI) {
              const redirectUrl = vastAdTagURI.textContent.trim();
              return await this.parseVAST(redirectUrl, redirectCount + 1);
            }
          }

          // Parse inline ad
          const inline = xml.querySelector('InLine');
          if (!inline) {
            throw new Error('No InLine ad found');
          }

          const adData = {
            title: this.getTextContent(inline, 'AdTitle'),
            duration: this.getTextContent(inline, 'Duration'),
            mediaFiles: [],
            trackingEvents: {},
            clickThrough: null,
            clickTracking: []
          };

          // Parse media files
          const mediaFiles = inline.querySelectorAll('MediaFile');
          mediaFiles.forEach(mf => {
            adData.mediaFiles.push({
              url: mf.textContent.trim(),
              type: mf.getAttribute('type'),
              width: mf.getAttribute('width'),
              height: mf.getAttribute('height'),
              delivery: mf.getAttribute('delivery'),
              bitrate: mf.getAttribute('bitrate')
            });
          });

          // Parse tracking events
          const trackingEvents = inline.querySelectorAll('Tracking');
          trackingEvents.forEach(te => {
            const event = te.getAttribute('event');
            if (!adData.trackingEvents[event]) {
              adData.trackingEvents[event] = [];
            }
            adData.trackingEvents[event].push(te.textContent.trim());
          });

          // Parse click tracking
          const clickThrough = inline.querySelector('ClickThrough');
          if (clickThrough) {
            adData.clickThrough = clickThrough.textContent.trim();
          }

          const clickTracking = inline.querySelectorAll('ClickTracking');
          clickTracking.forEach(ct => {
            adData.clickTracking.push(ct.textContent.trim());
          });

          log('VAST parsed successfully');
          return adData;

        } catch (error) {
          log(`Error parsing VAST: ${error.message}`);
          throw error;
        }
      }

      getTextContent(parent, tagName) {
        const element = parent.querySelector(tagName);
        return element ? element.textContent.trim() : null;
      }

      parseDuration(duration) {
        if (!duration) return 0;
        const parts = duration.split(':');
        const hours = parseInt(parts[0]) || 0;
        const minutes = parseInt(parts[1]) || 0;
        const seconds = parseFloat(parts[2]) || 0;
        return hours * 3600 + minutes * 60 + seconds;
      }
    }

    // VAST Player
    class VASTPlayer {
      constructor(videoElement, containerElement) {
        this.video = videoElement;
        this.container = containerElement;
        this.adData = null;
        this.trackingFired = {};
      }

      async loadAd(adData) {
        this.adData = adData;
        this.trackingFired = {};

        // Display ad info
        const duration = this.parseDuration(adData.duration);
        adDetails.innerHTML = `
          Title: ${adData.title || 'Unknown'}<br>
          Duration: ${duration > 0 ? duration.toFixed(1) + ' seconds' : 'Unknown'}<br>
          Media Files: ${adData.mediaFiles.length}<br>
          Tracking Events: ${Object.keys(adData.trackingEvents).length}
        `;

        // Select best media file (prefer MP4)
        const mediaFile = this.selectMediaFile(adData.mediaFiles);
        if (!mediaFile) {
          throw new Error('No suitable media file found');
        }

        log(`Selected media: ${mediaFile.type} (${mediaFile.width}x${mediaFile.height})`);

        // Load video
        this.video.src = mediaFile.url;
        
        // Show video when loaded
        this.video.addEventListener('loadeddata', () => {
          this.video.classList.add('loaded');
        }, { once: true });

        // Set up event listeners
        this.setupEventListeners();

        // Fire impression
        this.fireTracking('impression');

        // Play video
        try {
          await this.video.play();
          log('Ad playback started');
        } catch (error) {
          log(`Playback error: ${error.message}`);
        }
      }

      selectMediaFile(mediaFiles) {
        // Prefer progressive MP4
        const mp4 = mediaFiles.find(mf => 
          mf.type && mf.type.includes('mp4') && mf.delivery === 'progressive'
        );
        if (mp4) return mp4;

        // Fall back to any progressive delivery
        const progressive = mediaFiles.find(mf => mf.delivery === 'progressive');
        if (progressive) return progressive;

        // Fall back to first available
        return mediaFiles[0];
      }

      parseDuration(duration) {
        if (!duration) return 0;
        const parts = duration.split(':');
        const hours = parseInt(parts[0]) || 0;
        const minutes = parseInt(parts[1]) || 0;
        const seconds = parseFloat(parts[2]) || 0;
        return hours * 3600 + minutes * 60 + seconds;
      }

      setupEventListeners() {
        // Start event
        this.video.addEventListener('playing', () => {
          if (!this.trackingFired.start) {
            log('Ad started');
            this.fireTracking('start');
            this.trackingFired.start = true;
          }
        });

        // Progress events
        this.video.addEventListener('timeupdate', () => {
          if (!this.video.duration) return;
          
          const progress = this.video.currentTime / this.video.duration;
          
          if (progress >= 0.25 && !this.trackingFired.firstQuartile) {
            log('First quartile');
            this.fireTracking('firstQuartile');
            this.trackingFired.firstQuartile = true;
          }
          if (progress >= 0.5 && !this.trackingFired.midpoint) {
            log('Midpoint');
            this.fireTracking('midpoint');
            this.trackingFired.midpoint = true;
          }
          if (progress >= 0.75 && !this.trackingFired.thirdQuartile) {
            log('Third quartile');
            this.fireTracking('thirdQuartile');
            this.trackingFired.thirdQuartile = true;
          }
        });

        // Complete event
        this.video.addEventListener('ended', () => {
          log('Ad complete');
          this.fireTracking('complete');
        });

        // Error event
        this.video.addEventListener('error', (e) => {
          log(`Video error: ${this.video.error?.message || 'Unknown error'}`);
          this.fireTracking('error');
        });

        // Pause/Resume
        this.video.addEventListener('pause', () => {
          if (!this.video.ended) {
            this.fireTracking('pause');
          }
        });

        this.video.addEventListener('play', () => {
          if (this.trackingFired.start && !this.video.ended) {
            this.fireTracking('resume');
          }
        });

        // Mute/Unmute
        this.video.addEventListener('volumechange', () => {
          if (this.video.muted) {
            this.fireTracking('mute');
          } else {
            this.fireTracking('unmute');
          }
        });
      }

      fireTracking(eventName) {
        if (!this.adData || !this.adData.trackingEvents[eventName]) return;

        const urls = this.adData.trackingEvents[eventName];
        log(`Firing ${eventName} tracking (${urls.length} URLs)`);
        
        urls.forEach(url => {
          // Use Image object for tracking pixels
          const img = new Image();
          img.src = url;
        });
      }
    }

    // Initialize
    const vastParser = new VASTParser();
    const vastPlayer = new VASTPlayer(content, adContainer);

    // Load tag button
    document.querySelector('.gradient-btn').onclick = async () => {
      const tagUrl = document.getElementById('tag').value.trim();
      if (!tagUrl) {
        log('Enter a VAST tag URL');
        return;
      }

      log('=== Loading VAST Tag ===');
      adDetails.textContent = 'Loading ad info...';

      try {
        const adData = await vastParser.parseVAST(tagUrl);
        await vastPlayer.loadAd(adData);
      } catch (error) {
        log(`Failed to load ad: ${error.message}`);
        adDetails.textContent = `Error: ${error.message}`;
      }
    };

    // Clear logs
    document.getElementById('clearLogs').onclick = () => {
      logs.textContent = '';
    };

    // Refresh
    document.getElementById('refresh').onclick = () => {
      logs.textContent = '';
      adDetails.textContent = 'No ad loaded yet.';
      document.getElementById('tag').value = '';
      resizeTextarea(tagInput);
      content.pause();
      content.src = '';
      content.classList.remove('loaded');
      content.load();
    };

    // Macro replace
    document.getElementById('macroReplace').onclick = () => {
      const tag = document.getElementById('tag');
      const updated = tag.value.replace(/%%(.*?)%%/g, (_, inner) => `[${inner}]`);
      tag.value = updated;
      resizeTextarea(tag);
      log('Replaced %%...%% macros with [...]');
    };

    // Textarea auto-resize
    const tagInput = document.getElementById('tag');

    function resizeTextarea(el) {
      const style = window.getComputedStyle(el);
      const border = parseFloat(style.borderTopWidth) + parseFloat(style.borderBottomWidth);
      const currentHeight = el.offsetHeight;
      el.style.height = 'auto';
      const newHeight = el.scrollHeight + border;
      el.style.height = currentHeight + 'px';
      requestAnimationFrame(() => {
        el.style.height = newHeight + 'px';
      });
    }

    resizeTextarea(tagInput);
    tagInput.addEventListener('input', () => resizeTextarea(tagInput));

    log('VAST Tester ready');
  </script>
</body>
</html>
